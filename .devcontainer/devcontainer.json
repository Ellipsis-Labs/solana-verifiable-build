# ÿ™ÿ¥ÿ∫ŸäŸÑ ÿπŸÑŸâ devnet
./deploy_verify_advanced.sh devnet

# ÿ™ÿ¥ÿ∫ŸäŸÑ ÿπŸÑŸâ mainnet
./deploy_verify_advanced.sh mainnet

# ÿ™ÿ¥ÿ∫ŸäŸÑ ÿπŸÑŸâ localnet
./deploy_verify_advanced.sh localnet
#!/bin/bash
set -e

# ==============================
# üé® Logging functions (ŸÖŸÑŸàŸÜ)
# ==============================
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
RED="\033[0;31m"
BLUE="\033[0;34m"
NC="\033[0m" # No Color

log_info()    { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[‚úî]${NC} $1"; }
log_warn()    { echo -e "${YELLOW}[! WARN]${NC} $1"; }
log_error()   { echo -e "${RED}[‚úñ ERROR]${NC} $1"; }

# ==============================
# ‚öôÔ∏è Helper functions
# ==============================
check_command() {
  command -v "$1" >/dev/null 2>&1 || { log_error "$1 is not installed. Install it first."; exit 1; }
}

retry() {
  local n=0
  local max_retries=$1
  shift
  until "$@"; do
    n=$((n+1))
    if [ $n -ge $max_retries ]; then
      log_error "Command failed after $max_retries attempts: $*"
      return 1
    fi
    log_warn "Retrying ($n/$max_retries)..."
    sleep 2
  done
}

# ==============================
# üõ† Verify tools
# ==============================
check_command solana
check_command cargo
check_command solana-verify

# ==============================
# üåê Environment selection
# ==============================
ENV=${1:-devnet}
case $ENV in
  devnet) NETWORK_URL=${SOLANA_DEVNET_URL:-https://api.devnet.solana.com} ;;
  mainnet) NETWORK_URL=${SOLANA_MAINNET_URL:-https://api.mainnet-beta.solana.com} ;;
  localnet) NETWORK_URL=${SOLANA_LOCALNET_URL:-http://127.0.0.1:8899} ;;
  *) log_error "Invalid environment: choose devnet/mainnet/localnet"; exit 1 ;;
esac
log_info "Environment: $ENV ($NETWORK_URL)"

# ==============================
# ‚öôÔ∏è Project-specific ENV (ŸäŸÖŸÉŸÜ ÿ™ÿπÿØŸäŸÑŸá ŸÑŸÉŸÑ ŸÖÿ¥ÿ±Ÿàÿπ)
# ==============================
PROGRAM_NAME=${PROGRAM_NAME:-staking_program}
PROGRAM_LIB_NAME=${PROGRAM_LIB_NAME:-staking_program}
PROGRAM_ID=${PROGRAM_ID:-YourProgramIDHere1111111111111111111111111111111}
REPO_PATH=${REPO_PATH:-username/solana-staking-program}
UPLOADER_PUBKEY=$(solana address)

# ==============================
# üß± 1. Build
# ==============================
log_info "Building program..."
cargo build-sbf --manifest-path=programs/$PROGRAM_NAME/Cargo.toml

if [ ! -f "target/deploy/${PROGRAM_LIB_NAME}.so" ]; then
  log_error "Build failed: .so file not found!"
  exit 1
fi
log_success "Build complete: target/deploy/${PROGRAM_LIB_NAME}.so"

# ==============================
# üöÄ 2. Deploy
# ==============================
log_info "Deploying program..."
retry 3 solana program deploy -u $NETWORK_URL target/deploy/${PROGRAM_LIB_NAME}.so --program-id $PROGRAM_ID
log_success "Program deployed!"

# ==============================
# üßÆ 3. Verification build
# ==============================
log_info "Generating verification build..."
retry 3 solana-verify build \
  --program-id $PROGRAM_ID \
  --url $NETWORK_URL \
  --repo-url https://github.com/$REPO_PATH
log_success "Verification build generated!"

# ==============================
# üåê 4. Verify against repository
# ==============================
log_info "Verifying program against GitHub repo..."
retry 3 solana-verify verify-from-repo \
  -u $NETWORK_URL \
  --program-id $PROGRAM_ID \
  https://github.com/$REPO_PATH
log_success "Source verification successful!"

# ==============================
# ‚òÅÔ∏è 5. Trigger remote verification job
# ==============================
log_info "Submitting remote verification job..."
retry 3 solana-verify remote submit-job \
  --program-id $PROGRAM_ID \
  --uploader $UPLOADER_PUBKEY
log_success "Remote job submitted successfully!"

log_success "üéâ All steps completed!"
